trigger:
  branches:
    include:
    - refs/tags/v*

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
    displayName: 'Use Python 3.7'
    
  - script: |
      python -m pip install --upgrade pip
      pip install --user --upgrade setuptools wheel twine
    displayName: 'Install dependencies'
  
  - script: |
      MLFARM_VERSION=$(git describe --exact-match --tags $(git log -n1 --pretty='%h'))
      export MLFARM_VERSION="${MLFARM_VERSION//v}"
      echo "Version: ${MLFARM_VERSION}"
      python setup.py sdist bdist_wheel
      echo "Content:"
      ls dist
    displayName: 'Make archives'
  
  - script: |
      cat >> $HOME/.pypirc <<EOL
      $(mlfarm-pypi-twine.pypirc)
      EOL
    displayName: 'Add .pypirc'

  - script: |
      python -m twine upload --disable-progress-bar dist/*
    displayName: 'Upload to pypi'
  
  - script: |
      rm -rf $HOME/.pypirc
    displayName: 'Remove .pypirc'
